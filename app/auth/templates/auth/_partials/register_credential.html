<div>
  <p class="mb-2">
    You can set up this device to log in quickly with a biometric authentication
    (Fingerprint Reader or Facial Recognition), or using a hardware security
    key. Click Below to get started.
  </p>
  <button
    class="py-2 px-4 bg-green-600 font-bold uppercase shadow text-white rounded disabled:bg-gray-400"
    id="start-registration"
  >
    Setup Device Authentication
  </button>
  <div id="error-message" class="mt-2 text-red-600 hidden"></div>
  <div id="success-message" class="mt-2 text-green-600 hidden"></div>
  <div id="loading-message" class="mt-2 text-blue-600 hidden">
    Setting up authentication...
  </div>
</div>

<script>
  const startRegistrationButton = document.getElementById('start-registration');
  const errorDiv = document.getElementById('error-message');
  const successDiv = document.getElementById('success-message');
  const loadingDiv = document.getElementById('loading-message');

  function showError(message) {
    errorDiv.textContent = message;
    errorDiv.classList.remove('hidden');
    successDiv.classList.add('hidden');
    loadingDiv.classList.add('hidden');
    startRegistrationButton.disabled = false;
    startRegistrationButton.textContent = 'Try Again';
  }

  function showSuccess(message) {
    successDiv.textContent = message;
    successDiv.classList.remove('hidden');
    errorDiv.classList.add('hidden');
    loadingDiv.classList.add('hidden');
    startRegistrationButton.disabled = true;
    startRegistrationButton.textContent = 'Authentication Set Up!';
  }

  function showLoading(message) {
    loadingDiv.textContent = message;
    loadingDiv.classList.remove('hidden');
    errorDiv.classList.add('hidden');
    successDiv.classList.add('hidden');
    startRegistrationButton.disabled = true;
  }

  startRegistrationButton.addEventListener('click', async () => {
    try {
      // Clear previous messages and show loading
      showLoading('Setting up authentication...');
      
      // Get the options (already JSON parsed from backend)
      const options = {{ public_credential_creation_options | safe }};
      
      console.log('WebAuthn options:', options);
      
      // Start registration using the global function from base.html
      showLoading('Please complete the authentication on your device...');
      const attResp = await startRegistration(options);
      console.log('Registration response:', attResp);

      showLoading('Verifying authentication...');
      
      // Send verification request
      const verificationResp = await fetch('{{ url_for("auth.add_credential") }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(attResp),
      });

      const verificationJSON = await verificationResp.json();
      console.log('Verification response:', verificationJSON);

      if (verificationJSON && verificationJSON.verified) {
        showSuccess('Device authentication set up successfully! Redirecting...');
        // Redirect after success
        setTimeout(() => {
          window.location.href = '/';
        }, 2000);
      } else {
        const errorMsg = verificationJSON.error || 'Failed to verify the credential';
        showError(`Setup failed: ${errorMsg}`);
      }
    } catch (error) {
      console.error('WebAuthn registration error:', error);
      
      // Provide more specific error messages
      if (error.name === 'NotSupportedError') {
        showError('WebAuthn is not supported on this device or browser. Please try a different device.');
      } else if (error.name === 'SecurityError') {
        showError('Security error: Make sure you\'re on a secure connection (HTTPS) or localhost.');
      } else if (error.name === 'NotAllowedError') {
        showError('Authentication was cancelled or timed out. Please try again.');
      } else if (error.name === 'InvalidStateError') {
        showError('This authenticator is already registered. Please use a different device.');
      } else if (error.name === 'AbortError') {
        showError('Authentication was cancelled. Please try again.');
      } else {
        showError(`Setup failed: ${error.message || 'Unknown error'}`);
      }
    }
  });
</script>